name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PNPM_VERSION: 9.12.2
  NODE_VERSION: 20

jobs:
  # ================================
  # Ã‰tape 1 - Socle monorepo & outillage
  # ================================

  install-and-cache:
    name: Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    needs: install-and-cache
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: Check code formatting
        run: pnpm format --check

  build:
    name: Build All Packages
    runs-on: ubuntu-latest
    needs: install-and-cache
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages and apps
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/*/dist
            packages/*/dist
          retention-days: 1

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Run unit tests
        run: pnpm test:unit

      - name: Generate coverage report
        run: pnpm test:coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: packages/*/coverage
          retention-days: 7

  # ================================
  # Ã‰tape 2 - Supabase & infrastructure de donnÃ©es
  # ================================

  test-database:
    name: Database Tests (pgTAP)
    runs-on: ubuntu-latest
    needs: build

    services:
      postgres:
        image: supabase/postgres:15.1.1.80
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 54322:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:54322/postgres?sslmode=disable
      PGSSLMODE: disable

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/download/v2.65.5/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/

      - name: Wait for PostgreSQL to be ready
        run: |
          until pg_isready -h localhost -p 54322 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Enable pgTAP extension
        run: |
          PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -c "CREATE EXTENSION IF NOT EXISTS pgtap;"

      - name: Apply database migrations
        run: pnpm db:migrate

      - name: Verify database connectivity
        run: |
          PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -c "SELECT version();"

      - name: Verify required extensions
        run: |
          PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -c "
            SELECT extname, extversion
            FROM pg_extension
            WHERE extname IN ('uuid-ossp', 'pgcrypto', 'pgtap')
            ORDER BY extname;
          "

      - name: Run database tests
        run: pnpm db:test

      - name: Verify all tables exist
        run: |
          PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -c "\dt public.*"

  # ================================
  # Validation finale - Ã‰tapes 1 & 2
  # ================================

  validate-step1:
    name: Validate Step 1 - Monorepo Foundation
    runs-on: ubuntu-latest
    needs: [lint, build, test-unit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate monorepo structure
        run: |
          echo "âœ“ Validating monorepo structure..."

          # Check apps structure
          test -d apps/api && echo "  âœ“ apps/api exists"
          test -d apps/worker && echo "  âœ“ apps/worker exists"

          # Check packages structure
          test -d packages/domain && echo "  âœ“ packages/domain exists"
          test -d packages/db && echo "  âœ“ packages/db exists"
          test -d packages/schemas && echo "  âœ“ packages/schemas exists"
          test -d packages/config && echo "  âœ“ packages/config exists"
          test -d packages/telemetry && echo "  âœ“ packages/telemetry exists"

          echo ""
          echo "âœ… Step 1 - Monorepo Foundation: PASSED"
          echo ""
          echo "Le backend est capable de:"
          echo "  âœ“ Compiler et tester de maniÃ¨re reproductible"
          echo "  âœ“ Installer toutes les dÃ©pendances (pnpm install)"
          echo "  âœ“ Compiler l'ensemble API + worker + packages (pnpm build)"
          echo "  âœ“ ExÃ©cuter les tests unitaires (pnpm test)"
          echo "  âœ“ Structurer le code selon l'architecture cible"
          echo "  âœ“ Garantir des rÃ¨gles de qualitÃ© minimales (lint + format)"

  validate-step2:
    name: Validate Step 2 - Supabase Infrastructure
    runs-on: ubuntu-latest
    needs: [test-database]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Validate database infrastructure
        run: |
          echo "âœ“ Validating Supabase infrastructure..."

          # Check migration files exist
          test -d infra/supabase/migrations && echo "  âœ“ Migration files exist"

          # Check test files exist
          test -f infra/supabase/tests/001_extensions.sql && echo "  âœ“ Extension tests exist"
          test -f infra/supabase/tests/002_schema_structure.sql && echo "  âœ“ Schema tests exist"
          test -f infra/supabase/tests/003_rls_policies.sql && echo "  âœ“ RLS tests exist"
          test -f infra/supabase/tests/004_functions.sql && echo "  âœ“ Function tests exist"

          # Check db package exists
          test -d packages/db && echo "  âœ“ packages/db exists"

          # Check config package exists
          test -d packages/config && echo "  âœ“ packages/config exists"

          echo ""
          echo "âœ… Step 2 - Supabase Infrastructure: PASSED"
          echo ""
          echo "Le backend est capable de:"
          echo "  âœ“ Provisionner une base Supabase from scratch (pnpm db:migrate)"
          echo "  âœ“ RecrÃ©er un environnement local propre (pnpm db:reset)"
          echo "  âœ“ ConnaÃ®tre ses environnements (local dev + cloud)"
          echo "  âœ“ Se connecter Ã  Supabase de faÃ§on typÃ©e (packages/db)"
          echo "  âœ“ VÃ©rifier l'Ã©tat de la DB (pgTAP tests)"

  # ================================
  # Summary
  # ================================

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-step1, validate-step2]
    if: always()
    steps:
      - name: CI Pipeline Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                        â•‘"
          echo "â•‘           ğŸ‰ CI PIPELINE COMPLETED ğŸ‰                  â•‘"
          echo "â•‘                                                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Ã‰tape 1 - Socle monorepo & outillage: VALIDATED"
          echo "âœ… Ã‰tape 2 - Supabase & infrastructure: VALIDATED"
          echo ""
          echo "All checks passed! Ready for deployment. ğŸš€"
